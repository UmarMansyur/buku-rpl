# BAB VI MQTT

[//begin]: # "Autogenerated link references for markdown compatibility"

[//end]: # "Autogenerated link references",./;[l
]

## Pengertian MQTT

MQTT (Message Queuing Telemetry Transport) adalah protokol komunikasi yang digunakan untuk mengirimkan data dari satu device ke device lainnya yang berjalan diatas stack TCP/IP dan memiliki ukuran data dengan _low overhead_ yang sangat kecil. Stack TCP/IP sudah banyak didukung mikrokontroler seperti ESP8266, ESP32, Arduino, dsb.

MQTT merupakan standard protokol perpesanan OASIS untuk IoT (Internet of Things) dan merupakan protokol yang sangat populer di dunia IoT, karena kemudahan dalam mengirimkan data karena ukuran data yang sangat kecil.

MQTT dapat mengirimkan pesan atau data apapun seperti data binary, teks, XML ataupun JSON. protokol ini menggunakan model pubish dan subscribe yang berbeda dengan client server, dimana protocol ini terdapat MQTT broker yang bertugas sebagai pusat pengiriman data publisher ke subscriber, untuk platform node.js dapat menggunakan MQTT broker seperti Mosquitto, hiveMQ, Emqx dan lain sebagainya. MQTT client yang nantinya digunakan pada device seperti arduino, ESP8266, ESP32 dapat menggunakan library seperti PubSubClient, MQTT dan mqtt.js unutk platform node.js.

### Sinyal kontrol MQTT

MQTT memiliki 14 jenis kontrol sinyal yang dapat digunakan untuk mengirimkan pesan, diantaranya adalah:

- CONNECT – untuk menghubungkan ke broker
- CONNACK – untuk mengkonfirmasi koneksi ke broker
- PUBLISH – untuk mengirimkan pesan ke broker
- PUBACK – untuk mengkonfirmasi pesan yang dikirimkan ke broker
- PUBREC – untuk mengkonfirmasi pesan yang dikirimkan ke broker
- PUBREL – untuk mengkonfirmasi pesan yang dikirimkan ke broker
- PUBCOMP – untuk mengkonfirmasi pesan yang dikirimkan ke broker
- SUBSCRIBE – untuk mengirimkan permintaan untuk berlangganan ke broker
- SUBACK – untuk mengkonfirmasi permintaan untuk berlangganan ke broker
- UNSUBSCRIBE – untuk mengirimkan permintaan untuk berhenti berlangganan ke broker
- UNSUBACK – untuk mengkonfirmasi permintaan untuk berhenti berlangganan ke broker
- PINGREQ – untuk meminta broker untuk mengirimkan PINGRESP
- PINGRESP – untuk mengkonfirmasi PINGREQ
- DISCONNECT – untuk memutuskan koneksi ke broker

Dari sinyal tersebut hanya 3 sinyal utama yang dipake oleh client yaitu:

- PUBLISH
- SUBSCRIBE
- UNSUBSCRIBE

![MQTT Protocol!](https://mqtt.org/assets/img/mqtt-publish-subscribe.png "MQTT Protocol")

### Kelebihan MQTT

- Ringan

  MQTT merupakan protokol yang sangat ringan dan mudah digunakan. MQTT juga merupakan protokol yang sangat efisien dalam penggunaan sumber daya seperti bandwidth dan memori.

- Mudah digunakan

  MQTT merupakan protokol yang sangat mudah digunakan karena menggunakan protokol publish-subscribe.

- Efisien

  MQTT merupakan protokol yang sangat efisien dalam penggunaan sumber daya seperti bandwidth dan memori.

- Aman

  MQTT juga merupakan protokol yang sangat aman karena menggunakan enkripsi untuk mengamankan data yang dikirimkan.

- Cepat

  MQTT juga merupakan protokol yang sangat cepat karena menggunakan protokol publish-subscribe.

- Fleksibel

  MQTT juga merupakan protokol yang sangat fleksibel karena dapat digunakan untuk berbagai macam kebutuhan.

## Broker MQTT

Dalam protocol MQTT broker bertugas sebagai penghubung untuk menangani pesan yang dikirimkan publisher dan mengirimkan pesan ke subscriber yang terhubung ke jaringan Broker yang sama. Broker juga bertugas untuk menyimpan pesan yang dikirimkan oleh publisher jika tidak ada subscriber yang terhubung ke broker dan mengirimkannya ketika sudah ada subscriber yang terhubung ke broker.atau bisa disebut sebagai server yang bertugas untuk menghubungkan antara publisher dan subscriber yang memiliki allamat ip khusus.

Beberapa layanan broker mqtt yang bisa digunakan antara lain:

- [CloudMQTT](cloudmqtt.com/)
- [HiveMQ](www.hivemq.com/)
- [Mosquitto](mosquitto.org/)
- [Eclipse Mosquitto](mosquitto.org/)
- [CloudMQTT](cloudmqtt.com/)
- [HiveMQ](www.hivemq.com/)
- [Mosquitto](mosquitto.org/)
- [Eclipse Mosquitto](mosquitto.org/)

## Publish, Subscribe, Topic dan QoS

## Publish

Publish adalah proses pengiriman data dari publisher ke broker. Publisher akan mengirimkan data ke broker dengan menggunakan topik tertentu. Broker akan menyimpan data yang dikirimkan oleh publisher dan akan mengirimkan data tersebut ke subscriber yang berlangganan pada topik yang sama. Data yang dikirimkan oleh publisher akan disimpan di broker dengan durasi tertentu. Jika subscriber tidak menerima data yang dikirimkan oleh publisher, maka data tersebut akan hilang.

## Subscribe

Subscribe adalah proses penerimaan data dari broker ke subscriber. Subscriber akan menerima data dari broker dengan menggunakan topik tertentu. Broker akan mengirimkan data yang disimpan ke subscriber yang berlangganan pada topik yang sama. Data yang dikirimkan oleh broker akan disimpan di subscriber dengan durasi tertentu. Jika publisher tidak menerima data yang dikirimkan oleh broker, maka data tersebut akan hilang.

## Topic

Dalam mqtt dikenal istilah Topic atau bisa diartikan sebagai judul merupakan string UTF-8 pada broker atau nama unik seperti alamat untuk memfilter pesan ketika mengirimkan data dari publisher ke broker dan dari broker ke subscriber. Topic juga digunakan untuk mengidentifikasi subscriber yang berlangganan pada topik yang sama dan juga digunakan untuk mengidentifikasi publisher yang mengirimkan data ke broker. Topic terdiri dari satu atau lebih level yang dipisahkan dengan tanda / (slash).

Misalnya jika ada publisher yang mengirimkan data dengan topik berikut:

```
sensor/ultrasonic
```

Maka subscriber akan menerima semua pesan yang dikirimkan oleh publisher dengan topik yang sama atau berawalan dengan topik tersebut.

## QoS

QoS adalah singkatan dari Quality of Service. QoS digunakan untuk menentukan tingkat keamanan data yang dikirimkan dari publisher ke broker dan dari broker ke subscriber. QoS memiliki 3 tingkat keamanan yaitu:

- QoS 0 (At most once)

  pesan yang dikirimkan oleh publisher ke broker dan dari broker ke subscriber tidak akan disimpan di broker dan subscriber. Jika terjadi kegagalan pengiriman pesan, maka pesan tersebut akan hilang.

- QoS 1 (At least once)

  pesan yang dikirimkan oleh publisher ke broker dan dari broker ke subscriber akan disimpan di broker dan subscriber. Jika terjadi kegagalan pengiriman pesan, maka pesan tersebut akan dikirimkan ulang.

- QoS 2 (Exactly once)

  pesan yang dikirimkan oleh publisher ke broker dan dari broker ke subscriber akan disimpan di broker dan subscriber. Jika terjadi kegagalan pengiriman pesan, maka pesan tersebut akan dikirimkan ulang. Pesan yang dikirimkan oleh publisher akan disimpan di broker sampai pesan tersebut diterima oleh subscriber.

## mqtt.js

mqtt.js merupakan library javascript yang digunakan untuk mengirim dan menerima data dari broker mqtt. mqtt.js dapat digunakan untuk membuat publisher dan subscriber. mqtt.js dapat digunakan untuk membuat aplikasi web, aplikasi mobile, dan aplikasi desktop.

### Membuat project menggunakan node.js

Buatlah project baru menggunakan node.js dengan cara berikut:

1. Buka terminal atau command prompt
2. Ketikkan perintah berikut untuk membuat project baru dengan nama mqtt.js

```powershell
npm init -y
```

3. Install mqtt.js dengan cara ketikkan perintah berikut

```powershell
npm install mqtt --save
```

4. Buatlah file baru dengan nama index.js

5. Buka file index.js

6. Import library mqtt.js

```js
const mqtt = require("mqtt");
```

7. Menghubungkan ke broker mqtt

Untuk broker mqtt yang digunakan pada project kali ini adalah broker mqtt dari hiveMQ.

- Broker : broker.hivemq.com
- TCP Port : 1883
- Websocket Port : 8000

set parameter address, port dan fungsi untuk membuat angka random di javascript untuk membuat client Id

```js
const host = "broker.hivemq.com";
const port = 1883;
const clientId = "mqtt_${Math.random().toString(16).slice(3)}";
```

8. Membuat fungsi untuk koneksi mqtt dengan membuat parameter koneksi dan url untuk koneksi menggunakan host dan port yang sudah ditentukan, kemudian memanggil fungsi koneksi dari library mqtt.

```js
const connectUrl = `mqtt://${host}:${port}`;

const client = mqtt.connect(connectUrl, {
  clientId,
  clean: true,
  connectTimeout: 4000,
  reconnectPeriod: 1000,
  username: "test",
  password: "test",
});
```

9. Melakukan Subscribe

menggunakan fungsi on untuk melakukan subscribe dengan parameter topic dan fungsi callback yang akan dijalankan ketika ada data yang dikirimkan oleh publisher menggunakan topic _/mqtt/test_.

```js
const topic = "/mqtt/test";

client.on("connect", () => {
  console.log("Connected to MQTT Broker");
  client.subscribe([topic], (err) => {
    if (err) {
      console.log(err);
    }
    console.log("Subscribed to topic: " + topic);
  });
});
```

Setelah sukses subscribe ke topic, gunakan fungsi on untuk menerima data yang dikirimkan oleh publisher dengan parameter topic dan fungsi callback yang akan dijalankan ketika ada data yang dikirimkan oleh publisher.

```js
client.on("message", (topic, payload) => {
  console.log(
    "Received message: " + payload.toString() + " on topic: " + topic
  );
});
```

10. Melakukan Publish

menggunakan fungsi publish untuk melakukan publish dengan parameter topic, data yang akan dikirimkan dan fungsi callback yang akan dijalankan ketika data berhasil dikirimkan.

```js
const data = "Hello MQTT";

client.publish(topic, data, { qos: 0, retain: false }, (err) => {
  if (err) {
    console.log(err);
  }
  console.log("Published data: " + data + " to topic: " + topic);
});
```

### kode keseluruhan index.js

```js
const mqtt = require("mqtt");

const host = "broker.hivemq.com";
const port = 1883;
const clientId = "mqtt_${Math.random().toString(16).slice(3)}";

const connectUrl = `mqtt://${host}:${port}`;

const client = mqtt.connect(connectUrl, {
  clientId,
  clean: true,
  connectTimeout: 4000,
  reconnectPeriod: 1000,
  username: "test",
  password: "test",
});

const topic = "mqtt/test";

client.on("connect", () => {
  console.log("Connected to MQTT Broker");
  client.subscribe([topic], (err) => {
    if (err) {
      console.log(err);
    }
    console.log("Subscribed to topic: " + topic);
  });
});

const data = "Hello MQTT";

client.publish(topic, data, { qos: 0, retain: false }, (err) => {
  if (err) {
    console.log(err);
  }
  console.log("Published data: " + data + " to topic: " + topic);
});

client.on("message", (topic, payload) => {
  console.log(
    "Received message: " + payload.toString() + " on topic: " + topic
  );
});
```

## Test

1. buka website hiveMQ mqtt websocket client [https://www.hivemq.com/demos/websocket-client/](https://www.hivemq.com/demos/websocket-client/)

2. Masukkan host dan port yang digunakan pada project mqtt.js dan klik connect.

3. Masukkan topic yang digunakan pada project mqtt.js dan klik subscribe.

4. Buka terminal atau command promptpada folder project yang sebelumnya di buat

5. Ketikkan perintah berikut untuk menjalankan project

```powershell
node index.js
```

6. Kembali ke website hiveMQ mqtt websocket client dan cek apakah ada data yang dikirimkan oleh project mqtt.js

7. Jika ada data yang dikirimkan maka project mqtt.js sudah berhasil dijalankan.

8. publish data baru dengan mengisi data pada kolom publish di website hiveMQ dan klik publish.

9. Kembali ke terminal atau command prompt dan cek apakah ada data yang dikirimkan oleh website hiveMQ mqtt websocket client.

10. Jika ada data yang dikirimkan maka website hiveMQ mqtt websocket client sudah berhasil dijalankan.

## Mqtt Arduino

Pada project kali ini akan menggunakan board esp8266 sebagai publisher dan subscriber menggunakan library esp8266WiFi dan PubSubClient .

### Library

- esp8266WiFi

  Library untuk mengatur koneksi wifi pada board esp8266.

- PubSubClient

  Library untuk mengatur koneksi mqtt pada board esp8266.

### Koneksi

- Wifi

  - SSID : test

  - Password : test

- MQTT
  
    - Host : broker.hivemq.com
  
    - Port : 1883
  
    - Username : test
  
    - Password : test
    

### Membuat projectc mqtt arduino

1. Buka aplikasi arduino IDE

2. Pilih board yang digunakan yaitu Esp8266 dan pilih port yang digunakan untuk menghubungkan board dengan komputer. 

3. Install library yang dibutuhkan yaitu esp8266WiFi dan PubSubClient.

4. Buat file baru dengan nama mqtt_arduino.ino

5. Import library Esp8266WiFi dan PubSubClient

```cpp
#include <ESP8266WiFi.h> // library untuk mengatur koneksi wifi
#include <PubSubClient.h> // library untuk mengatur koneksi mqtt
```

6. Atur nama ssid dan password wifi yang digunakan

```cpp

const char* ssid = "test";
const char* password = "test";
```

7. Atur host, port, username dan password mqtt yang digunakan

```cpp

const char* mqtt_host = "broker.hivemq.com";
const int mqtt_port = 1883;
const char* mqtt_username = "test";
const char* mqtt_password = "test";
``` 

8. Atur topic yang digunakan

```cpp

const char* topic = "mqtt/test";
```

9. Atur koneksi wifi

```cpp

WiFiClient wifiClient;
PubSubClient client(mqtt_host, mqtt_port, wifiClient);
```

10. Buat fungsi untuk menghubungkan ke wifi dan mqtt

```cpp

void connectWifi() {
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("Connected to WiFi");
}

void connectMqtt() {
  while (!client.connected()) {
    if (client.connect("mqtt_arduino", mqtt_username, mqtt_password)) {
      Serial.println("Connected to MQTT");
      client.subscribe(topic);
    } else {
      Serial.print("Failed with state ");
      Serial.print(client.state());
      delay(2000);
    }
  }
}
```

11. Buat fungsi untuk mengirimkan data ke mqtt

```cpp

void publishMqtt() {
  String data = "Hello MQTT";
  client.publish(topic, data.c_str());
  Serial.println("Published data: " + data + " to topic: " + topic);
}
```

12. Buat fungsi untuk menerima data dari mqtt

```cpp

void callback(char* topic, byte* payload, unsigned int length) {
  Serial.print("Message arrived on topic: ");
  Serial.print(topic);
  Serial.print(". Message: ");
  String message;
  for (int i = 0; i < length; i++) {
    message += (char)payload[i];
  }
  Serial.println(message);
}
```

13. Buat fungsi setup dan loop

```cpp

void setup() {
  Serial.begin(115200);
  connectWifi();
  client.setCallback(callback);
}

void loop() {
  if (!client.connected()) {
    connectMqtt();
  }
  client.loop();
  publishMqtt();
  delay(5000);
}
```

14. Upload project ke board esp8266

15. Buka serial monitor untuk melihat hasilnya

### Kode lengkap arduino

```cpp

#include <ESP8266WiFi.h> // library untuk mengatur koneksi wifi
#include <PubSubClient.h> // library untuk mengatur koneksi mqtt

const char* ssid = "test";
const char* password = "test";

const char* mqtt_host = "broker.hivemq.com";
const int mqtt_port = 1883;
const char* mqtt_username = "test";
const char* mqtt_password = "test"

const char* topic = "mqtt/test";

WiFiClient wifiClient;

PubSubClient client(mqtt_host, mqtt_port, wifiClient);

void connectWifi() {
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("Connected to WiFi");
}

void connectMqtt() {
  while (!client.connected()) {
    if (client.connect("mqtt_arduino", mqtt_username, mqtt_password)) {
      Serial.println("Connected to MQTT");
      client.subscribe(topic);
    } else {
      Serial.print("Failed with state ");
      Serial.print(client.state());
      delay(2000);
    }
  }
}

void publishMqtt() {
  String data = "Hello MQTT";
  client.publish(topic, data.c_str());
  Serial.println("Published data: " + data + " to topic: " + topic);
}

void callback(char* topic, byte* payload, unsigned int length) {
  Serial.print("Message arrived on topic: ");
  Serial.print(topic);
  Serial.print(". Message: ");
  String message;
  for (int i = 0; i < length; i++) {
    message += (char)payload[i];
  }
  Serial.println(message);
}

void setup() {
  Serial.begin(115200);
  connectWifi();
  client.setCallback(callback);
}

void loop() {
  if (!client.connected()) {
    connectMqtt();
  }
  client.loop();
  publishMqtt();
  delay(5000);
}

```

### Test

1. buka website hiveMQ mqtt websocket client [https://www.hivemq.com/demos/websocket-client/](https://www.hivemq.com/demos/websocket-client/)

2. Masukkan host dan port yang digunakan pada project mqtt.ino dan klik connect.

3. Masukkan topic yang digunakan pada project mqtt.ino dan klik subscribe.

4. Upload project mqtt.ino ke board esp8266

5. Kembali ke website hiveMQ mqtt websocket client dan cek apakah ada data yang dikirimkan oleh project mqtt.ino

6. Jika ada data yang dikirimkan maka project mqtt.ino sudah berhasil dijalankan.

7. publish data baru dengan mengisi data pada kolom publish di website hiveMQ dan klik publish.

8. Kembali ke terminal atau command prompt dan cek apakah ada data yang dikirimkan oleh website hiveMQ mqtt websocket client.

9. Jika ada data yang dikirimkan maka website hiveMQ mqtt websocket client sudah berhasil dijalankan.



## Referensi

[https://www.hivemq.com/blog/mqtt-client-library-enyclopedia-mqtt-js/](https://www.hivemq.com/blog/mqtt-client-library-enyclopedia-mqtt-js/)

[https://www.hivemq.com/demos/websocket-client/](https://www.hivemq.com/demos/websocket-client/)

[https://www.hivemq.com/blog/mqtt-essentials-part-1-introducing-mqtt/](https://www.hivemq.com/blog/mqtt-essentials-part-1-introducing-mqtt/)

[https://www.hivemq.com/blog/mqtt-essentials-part-2-publish-subscribe/](https://www.hivemq.com/blog/mqtt-essentials-part-2-publish-subscribe/)

[https://www.hivemq.com/blog/mqtt-essentials-part-3-client-broker-connection-establishment/](https://www.hivemq.com/blog/mqtt-essentials-part-3-client-broker-connection-establishment/)

[https://www.hivemq.com/blog/mqtt-essentials-part-4-mqtt-quality-of-service-levels/](https://www.hivemq.com/blog/mqtt-essentials-part-4-mqtt-quality-of-service-levels/)

[https://www.hivemq.com/blog/mqtt-essentials-part-5-mqtt-topics-best-practices/](https://www.hivemq.com/blog/mqtt-essentials-part-5-mqtt-topics-best-practices/)

## Tugas

1. Buatlah project mqtt.js yang dapat melakukan publish dan subscribe ke broker mqtt yang digunakan pada project mqtt.js.

2. Buatlah project arduino yang dapat melakukan publish dan subscribe ke broker mqtt yang digunakan pada project arduino.

3. buatlah beberapa topic yang berbeda pada project mqtt.js.

4. publish dan subscribe ke beberapa topic yang berbeda pada project mqtt.js.

